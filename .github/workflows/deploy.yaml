name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - staging
          - both

jobs:
  validate-branch:
    name: Validate branch
    runs-on: ubuntu-latest
    steps:
      - name: Ensure workflow is run from main branch
        run: |
          if [ "${{ github.ref }}" != 'refs/heads/main' ]; then
            echo "::error::This workflow can only be run from the main branch. Current branch: ${{ github.ref }}"
            exit 1
          fi

  deploy-staging:
    name: Deploy staging
    needs: validate-branch
    if: inputs.environment == 'staging' || inputs.environment == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
      - uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935 # v2.1.8
        with:
          project_id: celo-mobile-alfajores
          credentials_json: ${{ secrets.ALFAJORES_SERVICE_ACCOUNT_KEY }}
      - uses: google-github-actions/setup-gcloud@77e7a554d41e2ee56fc945c52dfd3f33d12def9a # v2.1.4
        with:
          install_components: 'beta'
      - uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.3.0
        with:
          node-version-file: 'package.json'
          check-latest: true
      - run: yarn
      - run: yarn deploy:staging:http hooks-api

  deploy-production:
    name: Deploy production
    needs: validate-branch
    if: inputs.environment == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
      - uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935 # v2.1.8
        with:
          project_id: celo-mobile-mainnet
          credentials_json: ${{ secrets.MAINNET_SERVICE_ACCOUNT_KEY }}
      - uses: google-github-actions/setup-gcloud@77e7a554d41e2ee56fc945c52dfd3f33d12def9a # v2.1.4
        with:
          install_components: 'beta'
      - uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.3.0
        with:
          node-version-file: 'package.json'
          check-latest: true
      - run: yarn
      - run: yarn deploy:production:http hooks-api
